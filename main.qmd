---
title: "BeeCSI Taxonomic Analysis Report"
format:
  pdf:
    output-file: "./results/oxy_2021"
    output-ext: "pdf"
    toc: true
    toc-depth: 2
---
{{< pagebreak >}}

# Experiment Details
```{r, echo = TRUE}
# Data and metadata information
dataset_name <- "oxy_2021"
experiment_key <- read.csv("Taxonomic_Experiment_Key.csv")
```
**Grouping:**
```{r, echo = FALSE}
subset(experiment_key$highest.grouping, experiment_key$dataset_key == dataset_name)
```
  
**Year**:
```{r, echo = FALSE}
subset(experiment_key$year, experiment_key$dataset_key == dataset_name)
```
  
**Activity:**
```{r, echo = FALSE}
subset(experiment_key$activity, experiment_key$dataset_key == dataset_name)
```
  
**Stressor Name:**
```{r, echo = FALSE}
subset(experiment_key$highest.grouping, experiment_key$dataset_key == dataset_name)
```
  
**Number of Samples:**
```{r, echo = FALSE}
subset(experiment_key$X..Samples, experiment_key$dataset_key == dataset_name)
```
  
**Treatments:**
```{r, echo = FALSE}
if(subset(experiment_key$Number.of.Treatments, experiment_key$dataset_key == dataset_name) == 2) {
  treatmentNames <- c(subset(experiment_key$d0_treatment, experiment_key$dataset_key == dataset_name),
  subset(experiment_key$d1_treatment, experiment_key$dataset_key == dataset_name))
  
} else {
    treatmentNames <- c(subset(experiment_key$d0_treatment, experiment_key$dataset_key == dataset_name),
  subset(experiment_key$d1_treatment, experiment_key$dataset_key == dataset_name),
    subset(experiment_key$d2_treatment, experiment_key$dataset_key == dataset_name))
}

treatmentNames
```

**Description:**
```{r, echo = FALSE}
subset(experiment_key$Description, experiment_key$dataset_key == dataset_name)
```


```{r install, message=FALSE, warning=FALSE, echo = FALSE}
# install requirements and set directories. 
if (!requireNamespace("glue", quietly = TRUE))
    install.packages("glue")
if (!requireNamespace("png", quietly = TRUE))
    install.packages("png")

library("glue")
library("png")

path <- getwd()

# Kept in case this ever gets changed. 
main_outdir <- glue("{path}/results/{dataset_name}")
nmds_dir <- glue("{main_outdir}/nmds_anosim")
alpha_div_dir <- glue("{main_outdir}/alpha_diversity")
rel_abund_dir <-  glue("{main_outdir}/relative_abundance")
# <DA> Subdirectory for kraken report matrices
kraken_matrix_dir <-
  glue("{main_outdir}/aggregated_kraken_reports")
# <DA> Subdirectory for DA results
da_dir <- glue("{main_outdir}/differential_abundance")
da_fitzig_dir <- glue("{da_dir}/fitzig")
da_ancombc_dir <- glue("{da_dir}/ancombc")
ind_sp_dir <- glue("{main_outdir}/differential_abundance/indicator_species_analysis")

```
{{< pagebreak >}}

# Alpha Diversity
## Kruskal Wallis Test

```{r, echo = FALSE, comment=''}
cat(readLines(glue('{alpha_div_dir}/alpha_stats.txt')), sep = "\n")
```
{{< pagebreak >}}

## Alpha diversity value table
```{r, echo = FALSE}
knitr::kable(glue("{alpha_div_dir}/alpha_div_data.csv"), col.names = "File Location")

alphaSummary <- read.csv(glue("{alpha_div_dir}/alpha_div_data.csv"))

alphaSummaryKey <- c("Sample", "Observed Richness", "Inverse Simpson", "Simpson", "Shannon", "Evenness", "Replicate", "Treatment")

knitr::kable(alphaSummary, col.names = alphaSummaryKey, digits = 4)
```
{{< pagebreak >}}

## Shannon Plot
```{r, echo = FALSE}
knitr::kable(glue("{alpha_div_dir}/alpha_div_shannon.png"), col.names = "File Location")

# Figure Import 
alphaShannon <- readPNG(glue("{alpha_div_dir}/alpha_div_shannon.png"), native = TRUE, info = TRUE)

# displaying an imported image:
grid::grid.raster(alphaShannon)
treatmentNames
```
{{< pagebreak >}}

## Simpson Plot
```{r, echo = FALSE}
knitr::kable(glue("{alpha_div_dir}/alpha_div_simpson.png"), col.names = "File Location")

# Figure Import 
alphaSimpson <- readPNG(glue("{alpha_div_dir}/alpha_div_simpson.png"), native = TRUE, info = TRUE)

# displaying an imported image:
grid::grid.raster(alphaSimpson)
treatmentNames
```
{{< pagebreak >}}

# Differential Abundance - ANCOM-BC

## ANCOM-BC: Taxa LevelGenus

```{r, echo = FALSE}
# I have to get the names changed or figure out Lance's method if it is modular and I missed it. 

knitr::kable(glue("{da_ancombc_dir}/{dataset_name}_Genus_ancombc.csv"), col.names = "File Location")

# Generalize this the output names are not good for this right now. 
genusANCOM <- read.csv(glue("{da_ancombc_dir}/{dataset_name}_Genus_ancombc.csv"))

ancomColNames <- c("Genus", "log2", "lfc", "p-val", "q-val", "diff. abundant", "change type")

knitr::kable(genusANCOM, col.names = ancomColNames, digits = 4)
```

```{r, echo = FALSE}
# Basically copied from Jonathan Ho's code. 
controls <- c('control', 'unexposed')
all_treatments = read.csv(glue("{main_outdir}/treatmentKey.csv"), header = TRUE)
just_treats <- all_treatments[!all_treatments %in% controls]

base_title <- 'Cage Control vs'
  
plot_title_i <-
        paste(base_title, just_treats[1], '-', 'Genus', '-', dataset_name)

Temp <- readPNG(glue("{da_ancombc_dir}/{plot_title_i}.png"), native = TRUE, info = TRUE)
grid::grid.raster(Temp)

```

```{r, echo = FALSE}
if (length(just_treats) == 2) {
  plot_title_i <-
          paste(base_title, just_treats[2], '-', 'Genus', '-', dataset_name)
  
  Temp <- readPNG(glue("{da_ancombc_dir}/{plot_title_i}.png"), native = TRUE, info = TRUE)
  grid::grid.raster(Temp)
}
```

{{< pagebreak >}}

## ANCOM-BC: Taxa Level Species

```{r, echo = FALSE}
# I have to get the names changed or figure out Lance's method if it is modular and I missed it. 

knitr::kable(glue("{da_ancombc_dir}/{dataset_name}_Species_ancombc.csv"), col.names = "File Location")

# Generalize this the output names are not good for this right now. 
speciesANCOM <- read.csv(glue("{da_ancombc_dir}/{dataset_name}_Species_ancombc.csv"))

ancomColNames <- c("Species", "log2", "lfc", "p-val", "q-val", "diff. abundant", "change type")

knitr::kable(speciesANCOM, col.names = ancomColNames, digits = 4)
```
{{< pagebreak >}}

```{r, echo = FALSE}
plot_title_i <-
        paste(base_title, just_treats[1], '-', 'Species', '-', dataset_name)

Temp <- readPNG(glue("{da_ancombc_dir}/{plot_title_i}.png"), native = TRUE, info = TRUE)
grid::grid.raster(Temp)
```

```{r, echo = FALSE}
if (length(just_treats) == 2) {
  plot_title_i <-
          paste(base_title, just_treats[2], '-', 'Species', '-', dataset_name)
  
  Temp <- readPNG(glue("{da_ancombc_dir}/{plot_title_i}.png"), native = TRUE, info = TRUE)
  grid::grid.raster(Temp)
}
```

{{< pagebreak >}}

# Beta Diversity
## ANOSIM Test
```{r, echo = FALSE, comment=''}
temp <- readLines(glue("{nmds_dir}/anosim.txt"))

temp <-gsub(",\\s*distance",",\n\tdistance",temp)

cat(temp, sep = "\n")
```

{{< pagebreak >}}

## NMDS Plots
### NMDS: Taxa Level Genus
```{r, echo = FALSE}
knitr::kable(glue("{nmds_dir}/nmds_plot_treatment_genus.png"), col.names = "File Location")

genusMNDS <- readPNG(glue("{nmds_dir}/nmds_plot_treatment_genus.png"), native = TRUE, info = TRUE)
grid::grid.raster(genusMNDS)
```

{{< pagebreak >}}

```{r, echo = FALSE}
# I have to get the names changed or figure out Lance's method if it is modular and I missed it. 

knitr::kable(glue("{nmds_dir}/nmds_plot_data_genus.csv"), col.names = "File Location")

# Generalize this the output names are not good for this right now. 
genusNMDS <- read.csv(glue("{nmds_dir}/nmds_plot_data_genus.csv"))
knitr::kable(genusNMDS)
```

{{< pagebreak >}}

### NMDS: Taxa Level Species
```{r, echo = FALSE}
knitr::kable(glue("{nmds_dir}/nmds_plot_treatment_species.png"), col.names = "File Location")

speciesMNDS <- readPNG(glue("{nmds_dir}/nmds_plot_treatment_species.png"), native = TRUE, info = TRUE)
grid::grid.raster(speciesMNDS)
```

{{< pagebreak >}}

```{r, echo = FALSE}
# I have to get the names changed or figure out Lance's method if it is modular and I missed it. 

knitr::kable(glue("{nmds_dir}/nmds_plot_data_species.csv"), col.names = "File Location")

# Generalize this the output names are not good for this right now. 
speciesNMDS <- read.csv(glue("{nmds_dir}/nmds_plot_data_species.csv"))
knitr::kable(speciesNMDS)
```
{{< pagebreak >}}

# Relative Abundance
```{r, echo = FALSE}
knitr::kable(glue("{rel_abund_dir}/relative_abundance_plot.png"), col.names = "File Location")

speciesMNDS <- readPNG(glue("{rel_abund_dir}/relative_abundance_plot.png"), native = TRUE, info = TRUE)
grid::grid.raster(speciesMNDS)
```

{{< pagebreak >}}

```{r, echo = FALSE}
# Generalize this the output names are not good for this right now. 
# Make wide table into long table?

knitr::kable(glue("{rel_abund_dir}/relative_abundance_proportions.csv"), col.names = "File Location")

relativeAbundanceCSV <- read.csv(glue("{rel_abund_dir}/relative_abundance_proportions.csv"))

RelColNames <-  colnames(relativeAbundanceCSV)
RelColNames <- gsub('.', '\ ', RelColNames, fixed = TRUE)

colnames(relativeAbundanceCSV) <- RelColNames

knitr::kable(relativeAbundanceCSV[,c(1,2,3,4,14,15)], digits = 4)
knitr::kable(relativeAbundanceCSV[,c(1,5,6,7,14,15)], digits = 4)
knitr::kable(relativeAbundanceCSV[,c(1,8,9,10,14,15)], digits = 4)
knitr::kable(relativeAbundanceCSV[,c(1,11,12,13,14,15)], digits = 4)
```
{{< pagebreak >}}

# Differential Abundance: IndicSpecies (Indicator Species Analysis)
## Factor: Treatment - Taxa Level: All
``` {r, echo = FALSE, comment=''}
temp <- readLines(glue("{ind_sp_dir}/{dataset_name}_treatment_indicators_all.txt"))

temp <-gsub("\t","",temp)

cat(temp, sep = "\n")
```

{{< pagebreak >}}

## Factor: Treatment - Taxa Level: Genus
``` {r, echo = FALSE, comment=''}
temp <- readLines(glue("{ind_sp_dir}/{dataset_name}_treatment_indicators_Genus.txt"))

temp <-gsub("\t","",temp)

cat(temp, sep = "\n")
```
{{< pagebreak >}}

## Factor: Treatment - Taxa Level: Species
``` {r, echo = FALSE, comment=''}
temp <- readLines(glue("{ind_sp_dir}/{dataset_name}_treatment_indicators_Species.txt"))

temp <-gsub("\t","",temp)

cat(temp, sep = "\n")
```
{{< pagebreak >}}

## Factor: Replicate - Taxa Level: All
``` {r, echo = FALSE, comment=''}
temp <- readLines(glue("{ind_sp_dir}/{dataset_name}_replicate_indicators_all.txt"))

temp <-gsub("\t","",temp)

cat(temp, sep = "\n")
```
{{< pagebreak >}}

## Factor: Replicate - Taxa Level: Genus
``` {r, echo = FALSE, comment=''}
temp <- readLines(glue("{ind_sp_dir}/{dataset_name}_replicate_indicators_Genus.txt"))

temp <-gsub("\t","",temp)

cat(temp, sep = "\n")
```
{{< pagebreak >}}

## Factor: Replicate - Taxa Level: Species
``` {r, echo = FALSE, comment=''}
temp <- readLines(glue("{ind_sp_dir}/{dataset_name}_replicate_indicators_Species.txt"))

temp <-gsub("\t","",temp)

cat(temp, sep = "\n")
```
{{< pagebreak >}}

# Appendix A - IndicSpecies 
## Treatment - All
```{r, echo = FALSE}
knitr::kable(glue("{ind_sp_dir}/{dataset_name}_treatment_indicators_all.csv"), col.names = "File Location")

TreatAll <- read.csv(glue("{ind_sp_dir}/{dataset_name}_treatment_indicators_all.csv"))

knitr::kable(TreatAll, digits = 3)
```
{{< pagebreak >}}

## Treatment - Genus
```{r, echo = FALSE}
knitr::kable(glue("{ind_sp_dir}/{dataset_name}_treatment_indicators_Genus.csv"), col.names = "File Location")

TreatGenus <- read.csv(glue("{ind_sp_dir}/{dataset_name}_treatment_indicators_Genus.csv"))

knitr::kable(TreatGenus, digits = 3)
```
{{< pagebreak >}}

## Treatment - Species
```{r, echo = FALSE}
knitr::kable(glue("{ind_sp_dir}/{dataset_name}_treatment_indicators_Species.csv"), col.names = "File Location")

TreatSpp <- read.csv(glue("{ind_sp_dir}/{dataset_name}_treatment_indicators_Species.csv"))

knitr::kable(TreatSpp, digits = 3)
```
{{< pagebreak >}}
## Replicate - All
```{r, echo = FALSE}
knitr::kable(glue("{ind_sp_dir}/{dataset_name}_replicate_indicators_all.csv"), col.names = "File Location")

RepAll <- read.csv(glue("{ind_sp_dir}/{dataset_name}_replicate_indicators_all.csv"))

knitr::kable(RepAll, digits = 3)
```
{{< pagebreak >}}

## Replicate - Genus
```{r, echo = FALSE}
knitr::kable(glue("{ind_sp_dir}/{dataset_name}_replicate_indicators_Genus.csv"), col.names = "File Location")

RepGenus <- read.csv(glue("{ind_sp_dir}/{dataset_name}_replicate_indicators_Genus.csv"))

knitr::kable(RepGenus, digits = 3)
```
{{< pagebreak >}}

## Replicate - Species
```{r, echo = FALSE}
knitr::kable(glue("{ind_sp_dir}/{dataset_name}_replicate_indicators_Species.csv"), col.names = "File Location")

RepSpp <- read.csv(glue("{ind_sp_dir}/{dataset_name}_replicate_indicators_Species.csv"))

knitr::kable(RepSpp, digits = 3)
```
